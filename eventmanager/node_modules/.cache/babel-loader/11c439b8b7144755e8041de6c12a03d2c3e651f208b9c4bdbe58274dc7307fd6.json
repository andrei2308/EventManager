{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n      label: 0,\n      sent: function () {\n        if (t[0] & 1) throw t[1];\n        return t[1];\n      },\n      trys: [],\n      ops: []\n    },\n    f,\n    y,\n    t,\n    g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n        case 7:\n          op = _.ops.pop();\n          _.trys.pop();\n          continue;\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n            _.ops.push(op);\n            break;\n          }\n          if (t[2]) _.ops.pop();\n          _.trys.pop();\n          continue;\n      }\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\nexports.__esModule = true;\nvar OpenAPISecurityHandler = /** @class */function () {\n  function OpenAPISecurityHandler(args) {\n    var loggingKey = args && args.loggingKey ? args.loggingKey + ': ' : '';\n    if (!args) {\n      throw new Error(loggingKey + 'missing args argument');\n    }\n    var securityDefinitions = args.securityDefinitions;\n    var securityHandlers = args.securityHandlers;\n    var operationSecurity = args.operationSecurity;\n    if (!securityDefinitions || typeof securityDefinitions !== 'object') {\n      throw new Error(loggingKey + 'securityDefinitions must be an object');\n    }\n    if (!securityHandlers || typeof securityHandlers !== 'object') {\n      throw new Error(loggingKey + 'securityHandlers must be an object');\n    }\n    if (!operationSecurity || !Array.isArray(operationSecurity)) {\n      throw new Error(loggingKey + 'operationSecurity must be an Array');\n    }\n    this.operationSecurity = operationSecurity;\n    this.securitySets = operationSecurity.map(function (security) {\n      return Object.keys(security).map(function (scheme) {\n        if (!securityDefinitions[scheme]) {\n          throw new Error(loggingKey + 'Unknown security scheme \"' + scheme + '\" used in operation.');\n        }\n        if (!securityHandlers[scheme]) {\n          console.warn(loggingKey + 'No handler defined for security scheme \"' + scheme + '\"');\n          return null;\n        }\n        if (typeof securityHandlers[scheme] !== 'function') {\n          throw new Error(loggingKey + 'Security handlers must be functions.  Non function ' + 'given for scheme \"' + scheme + '\"');\n        }\n        return {\n          definition: securityDefinitions[scheme],\n          handler: securityHandlers[scheme],\n          scopes: security[scheme]\n        };\n      }).filter(/* tslint:disable-next-line:no-shadowed-variable */\n      function (security) {\n        return !!security;\n      });\n    }).filter(function (set) {\n      return set.length > 0;\n    });\n    if (!this.securitySets.length) {\n      this.handle = function () {\n        return Promise.resolve();\n      };\n    }\n  }\n  OpenAPISecurityHandler.prototype.handle = function (request) {\n    return __awaiter(this, void 0, void 0, function () {\n      var operationSecurity;\n      return __generator(this, function (_a) {\n        operationSecurity = this.operationSecurity;\n        return [2 /*return*/, this.securitySets.reduce(function (promiseChain, currentTask) {\n          return promiseChain.then(function (result) {\n            if (!result) {\n              var resultPromises = currentTask.map(function (securitySet) {\n                return securitySet.handler(request, securitySet.scopes, securitySet.definition);\n              });\n              return Promise.all(resultPromises).then(function (results) {\n                /* tslint:disable-next-line:no-shadowed-variable */\n                return results.filter(function (result) {\n                  return !result;\n                }).length === 0;\n              });\n            }\n            return Promise.resolve(result);\n          });\n        }, Promise.resolve(false)).then(function (result) {\n          if (!result) {\n            return Promise.reject({\n              status: 401,\n              message: 'No security handlers returned an acceptable response: ' + operationSecurity.map(toAuthenticationScheme).join(' OR '),\n              errorCode: 'authentication.openapi.security'\n            });\n          }\n        })];\n      });\n    });\n  };\n  return OpenAPISecurityHandler;\n}();\nexports[\"default\"] = OpenAPISecurityHandler;\nfunction toAuthenticationScheme(security) {\n  return Object.keys(security).join(' AND ');\n}","map":{"version":3,"names":["OpenAPISecurityHandler","args","loggingKey","Error","securityDefinitions","securityHandlers","operationSecurity","Array","isArray","securitySets","map","security","Object","keys","scheme","console","warn","definition","handler","scopes","filter","set","length","handle","Promise","resolve","prototype","request","reduce","promiseChain","currentTask","then","result","resultPromises","securitySet","all","results","reject","status","message","toAuthenticationScheme","join","errorCode"],"sources":["../index.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}