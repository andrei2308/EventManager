{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.initialize = void 0;\nconst openapi_framework_1 = require(\"openapi-framework\");\nconst CASE_SENSITIVE_PARAM_PROPERTY = 'x-express-openapi-case-sensitive';\nconst normalizeQueryParamsMiddleware = require('express-normalize-query-params-middleware');\nconst loggingPrefix = 'express-openapi';\nasync function initialize(args) {\n  if (!args) {\n    throw new Error(`${loggingPrefix}: args must be an object`);\n  }\n  if (!args.app) {\n    throw new Error(`${loggingPrefix}: args.app must be an express app`);\n  }\n  const exposeApiDocs = 'exposeApiDocs' in args ? !!args.exposeApiDocs : true;\n  if (args.docsPath && typeof args.docsPath !== 'string') {\n    throw new Error(`${loggingPrefix}: args.docsPath must be a string when given`);\n  }\n  if ('securityFilter' in args && typeof args.securityFilter !== 'function') {\n    throw new Error(`${loggingPrefix}: args.securityFilter must be a function when given`);\n  }\n  const app = args.app;\n  const docsPath = args.docsPath || '/api-docs';\n  const consumesMiddleware = args.consumesMiddleware;\n  const errorMiddleware = typeof args.errorMiddleware === 'function' && args.errorMiddleware.length === 4 ? args.errorMiddleware : null;\n  const promiseMode = !!args.promiseMode;\n  const securityFilter = args.securityFilter ? args.promiseMode ? toPromiseCompatibleMiddleware(args.securityFilter) : args.securityFilter : function defaultSecurityFilter(req, res, next) {\n    res.status(200).json(req.apiDoc);\n  };\n  const frameworkArgs = {\n    featureType: 'middleware',\n    name: loggingPrefix,\n    ...args\n  };\n  const framework = new openapi_framework_1.default(frameworkArgs);\n  await framework.initialize({\n    visitApi: ctx => {\n      if (exposeApiDocs || errorMiddleware) {\n        const basePaths = [];\n        basePaths.push(...ctx.basePaths.map(toExpressBasePath));\n        for (const basePath of basePaths) {\n          // Swagger UI support\n          if (exposeApiDocs) {\n            app.get(basePath + docsPath, (req, res, next) => {\n              // @ts-ignore\n              req.apiDoc = ctx.getApiDoc();\n              // @ts-ignore\n              if (req.apiDoc.swagger) {\n                // @ts-ignore\n                req.apiDoc.host = req.headers.host;\n                const apiBasePath = req.baseUrl + basePath;\n                // @ts-ignore\n                req.apiDoc.basePath = apiBasePath.length === 0 ? '/' : apiBasePath;\n              }\n              securityFilter(req, res, next);\n            });\n          }\n          // register custom error middleware to api's basePath\n          if (errorMiddleware) {\n            app.use(basePath, errorMiddleware);\n          }\n        }\n      }\n    },\n    visitOperation: ctx => {\n      const apiDoc = ctx.apiDoc;\n      const methodName = ctx.methodName;\n      const operationDoc = ctx.operationDoc;\n      const operationHandler = ctx.operationHandler;\n      let middleware = [].concat(ctx.additionalFeatures);\n      if (operationDoc && ctx.allowsFeatures) {\n        if (ctx.features.requestValidator) {\n          middleware.unshift(function requestValidatorMiddleware(req, res, next) {\n            next(ctx.features.requestValidator.validateRequest(req));\n          });\n        }\n        if (ctx.features.responseValidator) {\n          // add response validation middleware\n          // it's invalid for a method doc to not have responses, but the post\n          // validation will pick it up, so this is almost always going to be added.\n          middleware.unshift(function responseValidatorMiddleware(req, res, next) {\n            res.validateResponse = (statusCode, response) => {\n              return ctx.features.responseValidator.validateResponse(statusCode, response);\n            };\n            next();\n          });\n        }\n        if (ctx.features.coercer) {\n          middleware.unshift(function coercerMiddleware(req, res, next) {\n            ctx.features.coercer.coerce(req);\n            next();\n          });\n        }\n        if (ctx.features.defaultSetter) {\n          middleware.unshift(function defaultMiddleware(req, res, next) {\n            ctx.features.defaultSetter.handle(req);\n            next();\n          });\n        }\n        if (ctx.features.securityHandler) {\n          middleware.unshift((req, res, next) => {\n            ctx.features.securityHandler.handle(req).then(next).catch(next);\n          });\n        }\n        if (consumesMiddleware && ctx.consumes) {\n          addConsumesMiddleware(middleware, consumesMiddleware, ctx.consumes);\n        }\n        middleware.unshift(createAssignApiDocMiddleware(apiDoc, operationDoc));\n      }\n      middleware.push(operationHandler);\n      optionallyAddQueryNormalizationMiddleware(middleware, ctx.methodParameters);\n      if (promiseMode) {\n        middleware = [].concat.apply([], middleware).map(toPromiseCompatibleMiddleware);\n      }\n      const basePaths = [];\n      basePaths.push(...ctx.basePaths.map(toExpressBasePath));\n      for (const basePath of basePaths) {\n        const expressPath = basePath + '/' + ctx.path.substring(1).split('/').map(toExpressParams).join('/');\n        app[methodName].apply(app, [expressPath].concat(middleware));\n      }\n    }\n  });\n  return framework;\n}\nexports.initialize = initialize;\nfunction addConsumesMiddleware(middleware, consumesMiddleware, consumes) {\n  for (let i = consumes.length - 1; i >= 0; --i) {\n    const mimeType = consumes[i];\n    if (mimeType in consumesMiddleware) {\n      const middlewareToAdd = consumesMiddleware[mimeType];\n      middleware.unshift(middlewareToAdd);\n    }\n  }\n}\nfunction createAssignApiDocMiddleware(apiDoc, operationDoc) {\n  return function assignApiDocMiddleware(req, res, next) {\n    req.apiDoc = apiDoc;\n    req.operationDoc = operationDoc;\n    next();\n  };\n}\nfunction optionallyAddQueryNormalizationMiddleware(middleware, methodParameters) {\n  if (!methodParameters) {\n    return;\n  }\n  const queryParamsNeedingNormalization = methodParameters.filter(param => {\n    return param.in === 'query' && param[CASE_SENSITIVE_PARAM_PROPERTY] === false;\n  }).map(param => {\n    return param.name;\n  });\n  if (queryParamsNeedingNormalization.length) {\n    middleware.unshift(normalizeQueryParamsMiddleware(queryParamsNeedingNormalization));\n  }\n}\nfunction toExpressParams(part) {\n  return part.replace(/\\{([^}]+)}/g, ':$1');\n}\nfunction toPromiseCompatibleMiddleware(fn) {\n  if (typeof fn === 'function' && fn.name !== 'expressOpenapiPromiseMiddleware') {\n    return function expressOpenapiPromiseMiddleware(req, res, next) {\n      const potentialPromise = fn(req, res, next);\n      if (potentialPromise && typeof potentialPromise.catch === 'function') {\n        potentialPromise.catch(next);\n      }\n    };\n  }\n  return fn;\n}\nfunction toExpressBasePath(basePath) {\n  let path = basePath.path;\n  if (basePath.hasVariables()) {\n    path = path.replace(/:(\\w+)/g, (substring, p1) => {\n      if (basePath.variables[p1].enum) {\n        const validationRegex = `((${basePath.variables[p1].enum.join('|')}))`;\n        return `:${p1}${validationRegex}`;\n      } else {\n        return `:${p1}`;\n      }\n    });\n  }\n  return path;\n}","map":{"version":3,"names":["openapi_framework_1","require","CASE_SENSITIVE_PARAM_PROPERTY","normalizeQueryParamsMiddleware","loggingPrefix","initialize","args","Error","app","exposeApiDocs","docsPath","securityFilter","consumesMiddleware","errorMiddleware","length","promiseMode","toPromiseCompatibleMiddleware","defaultSecurityFilter","req","res","next","status","json","apiDoc","frameworkArgs","featureType","name","framework","default","visitApi","ctx","basePaths","push","map","toExpressBasePath","basePath","get","getApiDoc","swagger","host","headers","apiBasePath","baseUrl","use","visitOperation","methodName","operationDoc","operationHandler","middleware","concat","additionalFeatures","allowsFeatures","features","requestValidator","unshift","requestValidatorMiddleware","validateRequest","responseValidator","responseValidatorMiddleware","validateResponse","statusCode","response","coercer","coercerMiddleware","coerce","defaultSetter","defaultMiddleware","handle","securityHandler","then","catch","consumes","addConsumesMiddleware","createAssignApiDocMiddleware","optionallyAddQueryNormalizationMiddleware","methodParameters","apply","expressPath","path","substring","split","toExpressParams","join","exports","i","mimeType","middlewareToAdd","assignApiDocMiddleware","queryParamsNeedingNormalization","filter","param","in","part","replace","fn","expressOpenapiPromiseMiddleware","potentialPromise","hasVariables","p1","variables","enum","validationRegex"],"sources":["../index.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}