{"ast":null,"code":"\"use strict\";\n\nexports.__esModule = true;\nvar ajv_1 = require(\"ajv\");\nvar LOCAL_DEFINITION_REGEX = /^#\\/([^\\/]+)\\/([^\\/]+)$/;\nvar OpenAPIResponseValidator = /** @class */function () {\n  function OpenAPIResponseValidator(args) {\n    var loggingKey = args && args.loggingKey ? args.loggingKey + ': ' : '';\n    if (!args) {\n      throw new Error(\"\".concat(loggingKey, \"missing args argument\"));\n    }\n    if (!args.responses) {\n      throw new Error(\"\".concat(loggingKey, \"args.responses must be an Object\"));\n    }\n    if (!Object.keys(args.responses).length) {\n      throw new Error(\"\".concat(loggingKey, \"args.responses must contain at least 1 response object\"));\n    }\n    var errorTransformer = typeof args.errorTransformer === 'function' && args.errorTransformer;\n    var v = new ajv_1[\"default\"]({\n      useDefaults: true,\n      allErrors: true,\n      strict: false,\n      // @ts-ignore TODO get Ajv updated to account for logger\n      logger: false\n    });\n    this.errorMapper = errorTransformer ? makeErrorMapper(errorTransformer) : toOpenapiValidationError;\n    if (args.customFormats) {\n      Object.keys(args.customFormats).forEach(function (format) {\n        var func = args.customFormats[format];\n        if (typeof func === 'function') {\n          v.addFormat(format, func);\n        }\n      });\n    }\n    if (args.externalSchemas) {\n      Object.keys(args.externalSchemas).forEach(function (id) {\n        v.addSchema(args.externalSchemas[id], id);\n      });\n    }\n    var schemas = getSchemas(args.responses, args.definitions, args.components);\n    this.validators = compileValidators(v, schemas);\n  }\n  OpenAPIResponseValidator.prototype.validateResponse = function (statusCode, response) {\n    var validator;\n    if (statusCode && statusCode in this.validators) {\n      validator = this.validators[statusCode];\n    } else if (statusCode && statusCode.toString()[0] + 'XX' in this.validators) {\n      validator = this.validators[statusCode.toString()[0] + 'XX'];\n    } else if (this.validators[\"default\"]) {\n      validator = this.validators[\"default\"];\n    } else {\n      var message = 'An unknown status code was used and no default was provided.';\n      return {\n        message: message,\n        errors: [{\n          message: message\n        }]\n      };\n    }\n    var isValid = validator({\n      response: response === undefined ? null : response\n    });\n    if (!isValid) {\n      return {\n        message: 'The response was not valid.',\n        errors: validator.errors.map(this.errorMapper)\n      };\n    }\n    return undefined;\n  };\n  return OpenAPIResponseValidator;\n}();\nexports[\"default\"] = OpenAPIResponseValidator;\nfunction compileValidators(v, schemas) {\n  var validators = {};\n  Object.keys(schemas).forEach(function (name) {\n    validators[name] = v.compile(transformOpenAPIV3Definitions(schemas[name]));\n  });\n  return validators;\n}\nfunction getSchemas(responses, definitions, components) {\n  var schemas = {};\n  Object.keys(responses).forEach(function (name) {\n    var response = responses[name];\n    var schema = response ? typeof response.schema === 'object' ? response.schema : typeof response.content === 'object' && typeof response.content[Object.keys(response.content)[0]] === 'object' && typeof response.content[Object.keys(response.content)[0]].schema === 'object' ? response.content[Object.keys(response.content)[0]].schema : {\n      type: 'null'\n    } : {\n      type: 'null'\n    };\n    schemas[name] = {\n      $schema: 'http://json-schema.org/schema#',\n      type: 'object',\n      properties: {\n        response: schema\n      },\n      definitions: definitions || {},\n      components: components || {}\n    };\n  });\n  return schemas;\n}\nfunction makeErrorMapper(mapper) {\n  return function (ajvError) {\n    return mapper(toOpenapiValidationError(ajvError), ajvError);\n  };\n}\nfunction toOpenapiValidationError(error) {\n  var validationError = {\n    path: \"instance\".concat(error.instancePath),\n    errorCode: \"\".concat(error.keyword, \".openapi.responseValidation\"),\n    message: error.message\n  };\n  validationError.path = validationError.path.replace(/^instance\\/(response\\/)?/, '');\n  return validationError;\n}\nfunction recursiveTransformOpenAPIV3Definitions(object) {\n  // Transformations //\n  // OpenAPIV3 nullable\n  if (object.nullable === true) {\n    if (object[\"enum\"]) {\n      // Enums can not be null with type null\n      object.oneOf = [{\n        type: 'null'\n      }, {\n        type: object.type,\n        \"enum\": object[\"enum\"]\n      }];\n      delete object.type;\n      delete object[\"enum\"];\n    } else if (object.type) {\n      object.type = [object.type, 'null'];\n    } else if (object.allOf) {\n      object.anyOf = [{\n        allOf: object.allOf\n      }, {\n        type: 'null'\n      }];\n      delete object.allOf;\n    } else if (object.oneOf || object.anyOf) {\n      var arr = object.oneOf || object.anyOf;\n      arr.push({\n        type: 'null'\n      });\n    }\n    delete object.nullable;\n  }\n  // Remove writeOnly properties from required array\n  if (object.properties && object.required) {\n    var writeOnlyProps = Object.keys(object.properties).filter(function (key) {\n      return object.properties[key].writeOnly;\n    });\n    writeOnlyProps.forEach(function (value) {\n      var index = object.required.indexOf(value);\n      object.required.splice(index, 1);\n    });\n  }\n  Object.keys(object).forEach(function (attr) {\n    if (typeof object[attr] === 'object' && object[attr] !== null) {\n      recursiveTransformOpenAPIV3Definitions(object[attr]);\n    } else if (Array.isArray(object[attr])) {\n      object[attr].forEach(function (obj) {\n        return recursiveTransformOpenAPIV3Definitions(obj);\n      });\n    }\n  });\n}\nfunction transformOpenAPIV3Definitions(schema) {\n  if (typeof schema !== 'object') {\n    return schema;\n  }\n  var res = JSON.parse(JSON.stringify(schema));\n  recursiveTransformOpenAPIV3Definitions(res);\n  return res;\n}","map":{"version":3,"names":["ajv_1","require","LOCAL_DEFINITION_REGEX","OpenAPIResponseValidator","args","loggingKey","Error","concat","responses","Object","keys","length","errorTransformer","v","useDefaults","allErrors","strict","logger","errorMapper","makeErrorMapper","toOpenapiValidationError","customFormats","forEach","format","func","addFormat","externalSchemas","id","addSchema","schemas","getSchemas","definitions","components","validators","compileValidators","prototype","validateResponse","statusCode","response","validator","toString","message","errors","isValid","undefined","map","name","compile","transformOpenAPIV3Definitions","schema","content","type","$schema","properties","mapper","ajvError","error","validationError","path","instancePath","errorCode","keyword","replace","recursiveTransformOpenAPIV3Definitions","object","nullable","oneOf","allOf","anyOf","arr","push","required","writeOnlyProps","filter","key","writeOnly","value","index","indexOf","splice","attr","Array","isArray","obj","res","JSON","parse","stringify"],"sources":["../index.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}